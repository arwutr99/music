<!-- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Karaoke BY ARM</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #container { display: flex; flex-direction: row; }
    #main { flex: 1; padding: 20px; }
    #sidebar { width: 300px; padding: 20px; border-left: 1px solid #ccc; overflow-y: auto; max-height: 100vh; }
    #results button { display: block; margin: 10px 0; }
    .countdown { font-weight: bold; font-size: 1.2em; margin: 10px 0; color: darkred; }
    .playable-title { cursor: pointer; color: blue; text-decoration: underline; }
    .now-playing { background-color: #ffeeba; padding: 2px 6px; border-radius: 4px; }
    #manual-add, #apiKeyManager { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    @media screen and (max-width: 768px) { #sidebar { display: none; } }
  </style>
</head>
<body>
  <div id="container">
    <div id="main">
      <h1>Karaoke BY ARM</h1>
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞" />
      <button onclick="searchKaraoke()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div id="results"></div>
      <div id="player"></div>
      <div class="countdown" id="countdown"></div>
      <button onclick="skipSong()">‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      <button onclick="restartQueue()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
      <label><input type="checkbox" id="loopQueue"> ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏¥‡∏ß</label><br><br>
      <button onclick="exportQueue()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏ß</button>
      <input type="file" accept=".csv" id="queueFile" onchange="importQueue(event)" />

      <div id="manual-add">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</h3>
        <input id="manualUrl" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube" style="width: 60%;">
        <button onclick="addLinkToQueue()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</button>
      </div>

      <div>
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ API Key üîê</h3>
        <input type="password" id="unlockCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å">
        <button onclick="unlockManager()">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</button>
        <div id="apiKeyManager" style="display:none">
          <textarea id="apiKeyInput" rows="5" style="width:100%;"></textarea><br>
          <button onclick="saveApiKeys()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button onclick="exportApiKeys()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å API Key</button>
          <input type="file" accept=".txt" onchange="importApiKeys(event)">
        </div>
      </div>
    </div>
    <div id="sidebar">
      <h2>‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á</h2>
      <ol id="queue"></ol>
    </div>
  </div>

  <footer style="text-align:center;padding:10px;background:#f2f2f2;">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà LINE ID : armtrue ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå : 0864910528</footer>

  <script>
    let queue = JSON.parse(localStorage.getItem('karaokeQueue') || '[]');
    let currentIndex = 0;
    let nowPlayingIndex = -1;
    let player, countdownInterval, ytPlayerReady = false;

    let apiKeys;
    try {
      apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || ["AIzaSyB5ho_NRgYf8yZZgBGqP6LrEB4N2NsV85g"];
    } catch {
      apiKeys = ["AIzaSyB5ho_NRgYf8yZZgBGqP6LrEB4N2NsV85g"];
    }

    function updateQueueDisplay() {
      const list = document.getElementById('queue');
      list.innerHTML = '';
      queue.forEach((song, i) => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = song.title;
        span.className = 'playable-title';
        if (i === nowPlayingIndex) span.classList.add('now-playing');
        span.onclick = () => playSongAt(i);
        const remove = document.createElement('button');
        remove.textContent = '‡∏•‡∏ö';
        remove.onclick = () => { queue.splice(i, 1); updateQueueDisplay(); saveQueue(); };
        li.appendChild(span);
        li.appendChild(document.createTextNode(' '));
        li.appendChild(remove);
        list.appendChild(li);
      });
    }

    function playSongAt(index) {
      if (!queue[index]) return;
      nowPlayingIndex = index;
      currentIndex = index + 1;
      updateQueueDisplay();
      const videoId = queue[index].videoId;
      const div = document.getElementById('player');
      div.innerHTML = '<div id="ytplayer"></div>';
      if (window.YT && YT.Player) {
        player = new YT.Player('ytplayer', {
          videoId,
          width: "100%", height: "360",
          events: {
            onReady: e => { e.target.playVideo(); updateCountdown(); },
            onStateChange: e => {
              if (e.data === YT.PlayerState.ENDED) {
                setTimeout(playNext, 500);
              }
            }
          }
        });
      }
    }

    function playNext() {
      if (currentIndex >= queue.length) {
        if (document.getElementById('loopQueue').checked) currentIndex = 0;
        else return;
      }
      playSongAt(currentIndex++);
    }

    function restartQueue() {
      currentIndex = 0;
      playNext();
    }

    function skipSong() {
      if (player?.stopVideo) player.stopVideo();
      playNext();
    }

    function addToQueue(item) {
      const videoId = item.id.videoId;
      const title = item.snippet.title;
      if (!queue.find(q => q.videoId === videoId)) {
        queue.push({ title, videoId });
        updateQueueDisplay();
        saveQueue();
        if (queue.length === 1 && ytPlayerReady) playNext();
      }
    }

    function addLinkToQueue() {
      const url = document.getElementById('manualUrl').value.trim();
      const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (!match) return alert("‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      const videoId = match[1];
      if (queue.find(q => q.videoId === videoId)) return;
      let keyIndex = 0;
      function tryFetch() {
        fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${apiKeys[keyIndex]}`)
          .then(res => res.ok ? res.json() : (keyIndex++, keyIndex < apiKeys.length ? tryFetch() : Promise.reject()))
          .then(data => {
            const title = data.items?.[0]?.snippet?.title || `YouTube Video: ${videoId}`;
            queue.push({ title, videoId });
            updateQueueDisplay();
            saveQueue();
            if (queue.length === 1 && ytPlayerReady) playNext();
            document.getElementById('manualUrl').value = '';
          }).catch(() => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"));
      }
      tryFetch();
    }

    function searchKaraoke() {
      const query = document.getElementById('search').value + ' ‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞';
      let keyIndex = 0;
      function trySearch() {
        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=3&q=${encodeURIComponent(query)}&key=${apiKeys[keyIndex]}`)
          .then(res => res.ok ? res.json() : (keyIndex++, keyIndex < apiKeys.length ? trySearch() : Promise.reject()))
          .then(data => {
            const results = document.getElementById('results');
            results.innerHTML = '';
            data.items.forEach(item => {
              const btn = document.createElement('button');
              btn.textContent = item.snippet.title;
              btn.onclick = () => addToQueue(item);
              results.appendChild(btn);
            });
          }).catch(() => alert("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
      }
      trySearch();
    }

    function updateCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        if (player?.getDuration && player.getCurrentTime) {
          const remaining = Math.round(player.getDuration() - player.getCurrentTime());
          document.getElementById('countdown').textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${remaining} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
      }, 1000);
    }

    function exportQueue() {
      const csv = queue.map(q => `${q.title},${q.videoId}`).join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'karaoke.csv';
      a.click();
    }

    function importQueue(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.trim().split('\n');
        queue = lines.map(line => {
          const [title, videoId] = line.split(',');
          return { title, videoId };
        });
        updateQueueDisplay();
        saveQueue();
        playNext();
      };
      reader.readAsText(file);
    }

    function unlockManager() {
      if (document.getElementById('unlockCode').value === 'nimda') {
        document.getElementById('apiKeyManager').style.display = 'block';
        document.getElementById('apiKeyInput').value = apiKeys.join("\n");
      } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    }

    function saveApiKeys() {
      const keys = document.getElementById('apiKeyInput').value.trim().split(/\r?\n/);
      localStorage.setItem('apiKeys', JSON.stringify(keys));
      apiKeys = keys;
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    }

    function exportApiKeys() {
      const blob = new Blob([apiKeys.join('\n')], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "api_keys.txt";
      a.click();
    }

    function importApiKeys(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const keys = reader.result.trim().split(/\r?\n/);
        apiKeys = keys;
        localStorage.setItem('apiKeys', JSON.stringify(keys));
        document.getElementById('apiKeyInput').value = keys.join("\n");
        alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ API Key ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      };
      reader.readAsText(file);
    }

    function saveQueue() {
      localStorage.setItem('karaokeQueue', JSON.stringify(queue));
    }

    // ‡πÇ‡∏´‡∏•‡∏î YouTube IFrame API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
    function onYouTubeIframeAPIReady() { ytPlayerReady = true; if (queue.length > 0) playNext(); }

    // ENTER ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    document.getElementById('search').addEventListener('keydown', e => {
      if (e.key === 'Enter') searchKaraoke();
    });

    // ‡πÇ‡∏´‡∏•‡∏î queue ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå karaoke.csv ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    window.onload = () => {
      if (queue.length === 0) {
        fetch('karaoke.csv')
          .then(res => res.ok ? res.text() : '')
          .then(text => {
            if (text) {
              queue = text.trim().split('\n').map(line => {
                const [title, videoId] = line.split(',');
                return { title, videoId };
              });
              updateQueueDisplay();
              saveQueue();
              playNext();
            }
          });
      } else {
        updateQueueDisplay();
        playNext();
      }
    };
  </script>
</body>
</html>
